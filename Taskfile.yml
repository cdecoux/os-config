version: '3'

tasks:
  deploy:*:*:
    vars:
      NIXCONFIG_NAME: '{{index .MATCH 0}}'
      TARGET_HOST: '{{index .MATCH 1}}'
    cmds:
      - nixos-rebuild switch --flake .#{{.NIXCONFIG_NAME}} --target-host {{ .TARGET_HOST }} --use-remote-sudo {{.CLI_ARGS}}
  
  install:*:*:
    vars:
      NIXCONFIG_NAME: '{{index .MATCH 0}}'
      TARGET_HOST: '{{index .MATCH 1}}'
    cmd: |
      nix run github:nix-community/nixos-anywhere -- \
      --generate-hardware-config nixos-generate-config ./host/{{.NIXCONFIG_NAME}}/hardware-configuration.nix \
      --flake .#{{.NIXCONFIG_NAME}} --target-host {{.TARGET_HOST}} {{.CLI_ARGS}}
  
  vm:
    cmds: 
      - nixos-rebuild build-vm --flake .#homelab-nix
      - QEMU_NET_OPTS="hostfwd=tcp::2222-:22,hostfwd=tcp::8000-:8000,hostfwd=tcp::9443-:9443" result/bin/run-nixos-vm
